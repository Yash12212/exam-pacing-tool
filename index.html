<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Exam Pacing & Analytics Tool</title>
    
    <!-- Self-contained SVG Favicon for a professional touch -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⏱️</text></svg>">

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Chart.js and the Annotation Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <style>
        /* --- General & Layout --- */
        .screen {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Question Navigator Grid --- */
        #question-grid {
            display: grid;
            gap: 0.5rem;
            grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
        }
        .q-btn {
            aspect-ratio: 1 / 1;
            padding: 0;
        }
        .q-btn.current {
            transform: scale(1.1);
            z-index: 10;
        }
        
        /* --- Answer Options Grid --- */
        #answer-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        #answer-options .btn {
            aspect-ratio: 1 / 1;
            font-size: 1.5rem;
            font-weight: 600;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Pause & Confirmation Overlay Styles --- */
        #pause-overlay, #confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            z-index: 1050; /* Above most content */
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
            padding: 1rem; /* Good for small screens */
        }
        #confirmation-modal {
            z-index: 1060; /* Higher than pause overlay */
        }

        /* --- Reusable Container Styles (Moved from inline) --- */
        .progress-container {
            max-width: 400px;
            height: 12px;
        }
        .answer-options-container {
            max-width: 250px;
        }
        .scrollable-container {
            overflow-y: auto;
        }
        .question-grid-container {
            max-height: 210px;
        }
        .grading-list-container {
            max-height: 60vh;
        }
        .chart-container {
            position: relative;
            min-height: 250px;
        }

        /* --- Accessibility for Sortable Table Headers --- */
        .btn-sort {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            color: inherit;
            font-weight: inherit;
            text-decoration: none;
            text-align: left;
        }
        .btn-sort:hover {
            text-decoration: underline;
        }

        /* --- Collapsible Card Styles --- */
        .card-header .btn-collapse {
            text-decoration: none;
            color: inherit;
            text-align: left;
            padding: 0;
            background: none;
            border: none;
        }
        .collapse-icon {
            transition: transform 0.2s ease-in-out;
            width: 1.25em;
            height: 1.25em;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%236c757d'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-size: 1.25em;
        }
        .card-header .btn-collapse[aria-expanded="false"] .collapse-icon {
            transform: rotate(-90deg);
        }
        [data-bs-theme="dark"] .collapse-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23adb5bd'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
        }
    </style>
</head>
<body class="bg-body-secondary">

    <!-- Pause Overlay -->
    <div id="pause-overlay" class="d-none">
        <div class="card text-center shadow-lg">
            <div class="card-body p-4 p-md-5">
                <h2 class="card-title h3 mb-3">Exam Paused</h2>
                <p class="card-text text-body-secondary mb-4">Your time is stopped. Click below to continue.</p>
                <button id="resume-paused-btn" class="btn btn-primary btn-lg">Resume Exam</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="confirmation-modal" class="d-none">
        <div class="card text-center shadow-lg" style="max-width: 400px;">
            <div class="card-body p-4 p-md-5">
                <h2 id="confirm-title" class="card-title h4 mb-3">Confirmation</h2>
                <p id="confirm-message" class="card-text text-body-secondary mb-4">Are you sure?</p>
                <div class="d-flex justify-content-center gap-3">
                    <button id="confirm-cancel-btn" class="btn btn-secondary w-100">Cancel</button>
                    <button id="confirm-action-btn" class="btn btn-danger w-100">Confirm</button>
                </div>
            </div>
        </div>
    </div>


    <main class="container my-3 my-md-4">
        <div class="card shadow-sm border-light-subtle rounded-4 overflow-hidden">
            
            <!-- =========== SETUP SCREEN =========== -->
            <section id="setup-screen" class="screen p-3 p-sm-4 p-lg-5">
                <header>
                    <h1 class="display-6 display-md-5 fw-bold">Exam Pacing Tool</h1>
                    <p class="text-body-secondary mb-4">Set up your exam, track time, and see your results.</p>
                </header>
                
                <div id="resume-prompt" class="alert alert-info d-none">
                    <p class="fw-bold mb-2">Welcome Back!</p>
                    <p class="mb-2">It looks like you have an exam session in progress. Would you like to resume?</p>
                    <button id="resume-btn" class="btn btn-primary me-2">Yes, Resume Exam</button>
                    <button id="discard-btn" class="btn btn-outline-secondary">No, Start New</button>
                </div>

                <form id="setup-form">
                    <div class="row g-3 mb-3">
                        <div class="col">
                            <label for="start-question" class="form-label">Start Q#</label>
                            <input type="number" class="form-control" id="start-question" value="1" required min="1">
                        </div>
                        <div class="col">
                            <label for="end-question" class="form-label">End Q#</label>
                            <input type="number" class="form-control" id="end-question" value="50" required min="1">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="total-time" class="form-label">Total Time (minutes)</label>
                        <input type="number" class="form-control" id="total-time" value="60" required min="1">
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col">
                            <label for="positive-marking" class="form-label">Correct Answer Marks</label>
                            <input type="number" class="form-control" id="positive-marking" value="4" required step="any">
                        </div>
                        <div class="col">
                            <label for="negative-marking" class="form-label">Negative Marks (Deducted)</label>
                            <input type="number" class="form-control" id="negative-marking" value="1" required min="0" step="any">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="answer-key" class="form-label">Answer Key (Optional)</label>
                        <input type="text" class="form-control" id="answer-key" placeholder="e.g., a,d,b,c,a,...">
                        <div class="form-text">For auto-grading, enter correct answers separated by commas.</div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Start Exam</button>
                </form>
            </section>

            <!-- =========== EXAM SCREEN =========== -->
            <section id="exam-screen" class="screen d-none p-3 p-sm-4 p-lg-5">
                <!-- Collapsible Pacing Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <button class="btn-collapse w-100 d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePacing" aria-expanded="true" aria-controls="collapsePacing">
                            <h3 class="h5 mb-0">Pacing & Timer</h3>
                            <span class="collapse-icon"></span>
                        </button>
                    </div>
                    <div class="collapse show" id="collapsePacing">
                        <div class="card-body">
                            <div id="master-timer-container" class="text-center">
                                <div id="master-timer" class="display-5 display-md-4 font-monospace fw-bold" aria-live="polite">00:00:00</div>
                                <div class="progress mx-auto mt-2 progress-container" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                                    <div id="pacing-bar-inner" class="progress-bar rounded-pill bg-success" style="width: 100%;"></div>
                                </div>
                            </div>
                            <div id="pacing-indicators" class="row border-top pt-3 mt-3 g-3">
                                <div class="col-6 col-md-3 text-center">
                                    <span class="small text-body-secondary text-uppercase">Required Pace</span>
                                    <span id="required-pace" class="d-block h4 font-monospace fw-semibold">--:-- / q</span>
                                </div>
                                <div class="col-6 col-md-3 text-center">
                                    <span class="small text-body-secondary text-uppercase">Your Pace</span>
                                    <span id="current-pace" class="d-block h4 font-monospace fw-semibold">--:-- / q</span>
                                </div>
                                <div class="col-6 col-md-3 text-center">
                                    <span class="small text-body-secondary text-uppercase">Time Bank</span>
                                    <span id="time-bank" class="d-block h4 font-monospace fw-semibold" aria-live="polite">--:--</span>
                                </div>
                                <div class="col-6 col-md-3 text-center">
                                    <span class="small text-body-secondary text-uppercase">Marked</span>
                                    <span id="marked-counter" class="d-block h4 font-monospace fw-semibold" aria-live="polite">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Collapsible Current Question Card -->
                <div id="current-question-panel" class="card text-center mb-4">
                    <div class="card-header">
                         <button class="btn-collapse w-100 d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapseQuestionPanel" aria-expanded="true" aria-controls="collapseQuestionPanel">
                            <h2 id="current-q-number" class="h4 mb-0">Question 1</h2>
                            <span class="collapse-icon"></span>
                        </button>
                    </div>
                    <div class="collapse show" id="collapseQuestionPanel">
                        <div class="card-body p-4">
                            <div id="current-q-timer" class="display-6 display-md-5 font-monospace fw-bold mb-4" aria-live="polite">00:00</div>
                            <div id="answer-options" class="mx-auto answer-options-container">
                                <button class="btn btn-outline-secondary" data-answer="a">A</button>
                                <button class="btn btn-outline-secondary" data-answer="b">B</button>
                                <button class="btn btn-outline-secondary" data-answer="c">C</button>
                                <button class="btn btn-outline-secondary" data-answer="d">D</button>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent p-3">
                            <div id="navigation-controls" class="d-flex flex-column flex-sm-row gap-2">
                                <button id="prev-btn" class="btn btn-secondary flex-fill" disabled>« Previous</button>
                                <button id="mark-review-btn" class="btn btn-outline-secondary flex-fill">Mark for Review</button>
                                <button id="next-btn" class="btn btn-primary flex-fill">Next »</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Collapsible Navigator Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <button class="btn-collapse w-100 d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNavigator" aria-expanded="true" aria-controls="collapseNavigator">
                            <h3 class="h4 mb-0">Navigator</h3>
                            <span class="collapse-icon"></span>
                        </button>
                    </div>
                    <div class="collapse show" id="collapseNavigator">
                        <div class="card-body p-3">
                            <div class="scrollable-container question-grid-container">
                                <div id="question-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Action Buttons Group -->
                <div class="d-flex gap-2 justify-content-end">
                    <button id="pause-btn" class="btn btn-outline-primary">Pause Exam</button>
                    <button id="finish-btn" class="btn btn-danger">Finish & Grade</button>
                </div>
            </section>

            <!-- =========== GRADING SCREEN =========== -->
            <section id="grading-screen" class="screen d-none p-3 p-sm-4 p-lg-5">
                <h1 class="display-6 fw-bold">Answer Key Entry</h1>
                <p class="text-body-secondary mb-4">Exam over. Enter correct answers for attempted questions to generate your report.</p>
                <div id="grading-list" class="list-group list-group-flush border rounded-3 scrollable-container grading-list-container"></div>
                <button id="generate-analytics-btn" class="btn btn-primary w-100 mt-4" disabled>Generate Report</button>
            </section>

            <!-- =========== ANALYTICS SCREEN =========== -->
            <section id="analytics-screen" class="screen d-none p-3 p-sm-4 p-lg-5">
                <h1 class="display-6 fw-bold mb-4">Performance Report</h1>
                
                <div class="row g-3 g-lg-4 mb-4">
                    <!-- At a Glance Metrics Card -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <button class="btn-collapse w-100 d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMetrics" aria-expanded="true" aria-controls="collapseMetrics">
                                    <h3 class="h5 mb-0">At a Glance</h3>
                                    <span class="collapse-icon"></span>
                                </button>
                            </div>
                            <div class="collapse show" id="collapseMetrics">
                                <div class="card-body">
                                    <div class="row text-center g-3">
                                        <div class="col-6 col-sm-4 col-lg-2">
                                            <div class="h2 fw-bold" id="stat-score">--</div>
                                            <div class="text-body-secondary small">Final Score</div>
                                        </div>
                                        <div class="col-6 col-sm-4 col-lg-2">
                                            <div class="h2 fw-bold" id="stat-accuracy">--%</div>
                                            <div class="text-body-secondary small">Accuracy</div>
                                        </div>
                                        <div class="col-6 col-sm-4 col-lg-2">
                                            <div class="h2 fw-bold font-monospace" id="stat-pace-correct">--:--</div>
                                            <div class="text-body-secondary small">Pace (Correct)</div>
                                        </div>
                                        <div class="col-6 col-sm-4 col-lg-2">
                                            <div class="h2 fw-bold font-monospace" id="stat-pace-incorrect">--:--</div>
                                            <div class="text-body-secondary small">Pace (Incorrect)</div>
                                        </div>
                                        <div class="col-6 col-sm-4 col-lg-2">
                                            <div class="h2 fw-bold" id="stat-answered">--/--</div>
                                            <div class="text-body-secondary small">Attempted</div>
                                        </div>
                                        <div class="col-6 col-sm-4 col-lg-2">
                                            <div class="h2 fw-bold text-danger" id="stat-time-sinks">--</div>
                                            <div class="text-body-secondary small">Time Sinks</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-md-6">
                        <!-- Overall Summary Card -->
                        <div class="card h-100">
                             <div class="card-header">
                                <button class="btn-collapse w-100 d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSummary" aria-expanded="true" aria-controls="collapseSummary">
                                    <h3 class="h5 mb-0">Overall Summary</h3>
                                    <span class="collapse-icon"></span>
                                </button>
                            </div>
                            <div class="collapse show" id="collapseSummary">
                                <div class="card-body d-flex flex-column">
                                    <div class="chart-container flex-grow-1">
                                        <canvas id="score-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <!-- Pacing Scatter Plot Card -->
                        <div class="card h-100">
                             <div class="card-header">
                                <button class="btn-collapse w-100 d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePacingAnalysis" aria-expanded="true" aria-controls="collapsePacingAnalysis">
                                    <h3 class="h5 mb-0">Pacing Scatter Plot</h3>
                                    <span class="collapse-icon"></span>
                                </button>
                            </div>
                            <div class="collapse show" id="collapsePacingAnalysis">
                                <div class="card-body d-flex flex-column">
                                    <p class="card-text text-body-secondary small">Each dot is a question. The dashed line is your required pace.</p>
                                    <div class="chart-container flex-grow-1">
                                        <canvas id="pace-scatter-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Time Bank Trajectory Card -->
                    <div class="col-12 col-md-6">
                        <div class="card h-100">
                             <div class="card-header">
                                <button class="btn-collapse w-100 d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTimeBank" aria-expanded="true" aria-controls="collapseTimeBank">
                                    <h3 class="h5 mb-0">Time Bank History</h3>
                                    <span class="collapse-icon"></span>
                                </button>
                            </div>
                            <div class="collapse show" id="collapseTimeBank">
                                <div class="card-body d-flex flex-column">
                                    <p class="card-text text-body-secondary small">Shows your time buffer. Above the line is ahead of schedule, below is behind.</p>
                                    <div class="chart-container flex-grow-1">
                                        <canvas id="time-bank-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <!-- What If Scenario Card -->
                    <div class="col-12 col-md-6">
                        <div class="card h-100">
                             <div class="card-header">
                                <button class="btn-collapse w-100 d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapseScenarios" aria-expanded="true" aria-controls="collapseScenarios">
                                    <h3 class="h5 mb-0">Strategic Insights</h3>
                                    <span class="collapse-icon"></span>
                                </button>
                            </div>
                            <div class="collapse show" id="collapseScenarios">
                                <div class="card-body">
                                    <ul id="strategic-insights-list" class="list-unstyled mb-0">
                                        <!-- Insights will be populated here by JS -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <!-- Detailed Results Table Card -->
                        <div class="card">
                             <div class="card-header">
                                <button class="btn-collapse w-100 d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetailedResults" aria-expanded="true" aria-controls="collapseDetailedResults">
                                    <h3 class="h5 mb-0">Detailed Results</h3>
                                    <span class="collapse-icon"></span>
                                </button>
                            </div>
                            <div class="collapse show" id="collapseDetailedResults">
                                <div class="card-body">
                                    <p class="card-text text-body-secondary">Click headers to sort. Reviewed questions are highlighted.</p>
                                    <div class="table-responsive">
                                        <table id="detailed-results-table" class="table table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th><button class="btn-sort" data-sort="id">Q#</button></th>
                                                    <th><button class="btn-sort" data-sort="selectedAnswer">Your Ans</button></th>
                                                    <th><button class="btn-sort" data-sort="correctAnswer">Correct Ans</button></th>
                                                    <th><button class="btn-sort" data-sort="timeSpent">Time Spent</button></th>
                                                    <th><button class="btn-sort" data-sort="paceDeviation">Pace +/-</button></th>
                                                    <th><button class="btn-sort" data-sort="outcome">Outcome</button></th>
                                                    <th><button class="btn-sort" data-sort="markedForReview">Marked</button></th>
                                                </tr>
                                            </thead>
                                            <tbody id="detailed-results-tbody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="start-new-btn" class="btn btn-primary w-100 mt-2">Start New Exam</button>
            </section>
        </div>
    </main>
    
    <!-- Bootstrap 5.3 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
    // --- IIFE to prevent global scope pollution ---
    (function() {
        // --- DOM Element Selection ---
        const screens = { setup: document.getElementById('setup-screen'), exam: document.getElementById('exam-screen'), grading: document.getElementById('grading-screen'), analytics: document.getElementById('analytics-screen') };
        const setupForm = document.getElementById('setup-form');
        const startQuestionInput = document.getElementById('start-question');
        const endQuestionInput = document.getElementById('end-question');
        const totalTimeInput = document.getElementById('total-time');
        const positiveMarkingInput = document.getElementById('positive-marking');
        const negativeMarkingInput = document.getElementById('negative-marking');
        const answerKeyInput = document.getElementById('answer-key');
        const masterTimerEl = document.getElementById('master-timer');
        const requiredPaceEl = document.getElementById('required-pace');
        const currentPaceEl = document.getElementById('current-pace');
        const timeBankEl = document.getElementById('time-bank');
        const markedCounterEl = document.getElementById('marked-counter');
        const pacingBarInnerEl = document.getElementById('pacing-bar-inner');
        const questionGridEl = document.getElementById('question-grid');
        const currentQNumberEl = document.getElementById('current-q-number');
        const currentQTimerEl = document.getElementById('current-q-timer');
        const answerOptionButtons = document.querySelectorAll('#answer-options button');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const markReviewBtn = document.getElementById('mark-review-btn');
        const finishBtn = document.getElementById('finish-btn');
        const gradingListEl = document.getElementById('grading-list');
        const generateAnalyticsBtn = document.getElementById('generate-analytics-btn');
        const detailedResultsTbody = document.getElementById('detailed-results-tbody');
        const resumePromptEl = document.getElementById('resume-prompt');
        const resumeBtn = document.getElementById('resume-btn');
        const discardBtn = document.getElementById('discard-btn');
        const startNewBtn = document.getElementById('start-new-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const pauseOverlayEl = document.getElementById('pause-overlay');
        const resumePausedBtn = document.getElementById('resume-paused-btn');
        // --- Confirmation Modal Elements ---
        const confirmationModalEl = document.getElementById('confirmation-modal');
        const confirmTitleEl = document.getElementById('confirm-title');
        const confirmMessageEl = document.getElementById('confirm-message');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');


        // --- Centralized constants ---
        const CONSTANTS = {
            LOCAL_STORAGE_KEY: 'examPacingToolState_v4',
            STATUS_UNSEEN: 'unseen',
            STATUS_SEEN: 'seen',
            OUTCOME_CORRECT: 'correct',
            OUTCOME_INCORRECT: 'incorrect',
            OUTCOME_UNATTEMPTED: 'unattempted',
        };

        // --- State & Config Objects ---
        const config = {
            totalQuestions: 0, startQuestionNumber: 1, totalTimeSeconds: 0, positiveMarking: 0, negativeMarking: 0,
            requiredPaceSeconds: 0, answerKey: [],
        };
        
        const getInitialState = () => ({
            examData: [], currentQuestionIndex: 0, markedCount: 0, examStartTime: null,
            questionStartTime: null, timers: { master: null, pacing: null, question: null },
            sortState: { key: 'id', direction: 'asc' }, 
            charts: { score: null, pace: null, timeBank: null },
            isPaused: false, pauseStartTime: null,
        });
        
        let state = getInitialState();

        // --- Utility Functions ---
        const switchScreen = (screenName) => {
            Object.values(screens).forEach(s => s.classList.add('d-none'));
            if (screens[screenName]) screens[screenName].classList.remove('d-none');
            document.removeEventListener('keydown', handleKeyPress);
            if (screenName === 'exam') document.addEventListener('keydown', handleKeyPress);
        };

        const formatTime = (seconds, showHours = false) => {
            if (isNaN(seconds) || seconds === null) return showHours ? "00:00:00" : "--:--";
            const isNegative = seconds < 0;
            if (isNegative) seconds = -seconds;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            let timeString = (showHours || h > 0)
                ? `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`
                : `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            return isNegative ? `-${timeString}` : timeString;
        };
        
        const clearAllTimers = () => {
            Object.values(state.timers).forEach(timerId => clearInterval(timerId));
            state.timers = { master: null, pacing: null, question: null };
        };

        // --- Custom Confirmation Modal ---
        const showConfirmation = (config) => {
            const {
                title = 'Confirmation',
                message = 'Are you sure?',
                onConfirm,
                confirmText = 'Confirm',
                cancelText = 'Cancel',
                confirmClass = 'btn-danger'
            } = config;

            confirmTitleEl.textContent = title;
            confirmMessageEl.textContent = message;
            confirmActionBtn.textContent = confirmText;
            confirmCancelBtn.textContent = cancelText;

            confirmActionBtn.className = 'btn w-100'; // Reset classes
            confirmActionBtn.classList.add(confirmClass);
            
            confirmationModalEl.classList.remove('d-none');
            
            const hideModal = () => confirmationModalEl.classList.add('d-none');

            const handleConfirm = () => { hideModal(); onConfirm(); };
            const handleCancel = () => { hideModal(); };
            
            confirmActionBtn.addEventListener('click', handleConfirm, { once: true });
            confirmCancelBtn.addEventListener('click', handleCancel, { once: true });
        };

        // --- State Persistence Logic ---
        const saveStateToLocalStorage = () => {
            try {
                const stateToSave = {
                    config, state: {
                        examData: state.examData, currentQuestionIndex: state.currentQuestionIndex,
                        examStartTime: state.examStartTime, markedCount: state.markedCount,
                        isPaused: state.isPaused, pauseStartTime: state.pauseStartTime,
                    }
                };
                localStorage.setItem(CONSTANTS.LOCAL_STORAGE_KEY, JSON.stringify(stateToSave));
            } catch (e) { console.error("Could not save state to localStorage", e); }
        };

        const loadStateFromLocalStorage = () => {
            try {
                const savedStateJSON = localStorage.getItem(CONSTANTS.LOCAL_STORAGE_KEY);
                if (!savedStateJSON) return false;
                const saved = JSON.parse(savedStateJSON);

                let timeElapsed = (Date.now() - saved.state.examStartTime) / 1000;
                if (saved.state.isPaused && saved.state.pauseStartTime) {
                    timeElapsed = (saved.state.pauseStartTime - saved.state.examStartTime) / 1000;
                }
                
                if (saved.state.examStartTime && timeElapsed < saved.config.totalTimeSeconds) {
                    return saved;
                }
            } catch (e) { console.error("Could not load state from localStorage", e); }
            clearStateFromLocalStorage();
            return false;
        };

        const clearStateFromLocalStorage = () => localStorage.removeItem(CONSTANTS.LOCAL_STORAGE_KEY);

        const handleResume = (savedState) => {
            Object.assign(config, savedState.config);
            Object.assign(state, { ...getInitialState(), ...savedState.state });

            if (state.isPaused) {
                pauseOverlayEl.classList.remove('d-none');
                switchScreen('exam');
                updateMasterTimer(); 
                updatePacingIndicators();
                updatePerQuestionTimer();
            } else {
                startOrResumeExam();
            }
        };
        
        // --- Pause/Resume Logic ---
        function pauseExam() {
            if (state.isPaused) return;
            state.isPaused = true;
            state.pauseStartTime = Date.now();
            clearAllTimers();
            pauseOverlayEl.classList.remove('d-none');
            saveStateToLocalStorage();
        }

        function resumeFromPause() {
            if (!state.isPaused) return;
            const pauseDuration = Date.now() - state.pauseStartTime;
            state.examStartTime += pauseDuration;
            state.questionStartTime += pauseDuration;
            state.isPaused = false;
            state.pauseStartTime = null;
            pauseOverlayEl.classList.add('d-none');
            restartTimers();
            saveStateToLocalStorage();
        }
        
        function restartTimers() {
            clearAllTimers();
            state.timers.master = setInterval(updateMasterTimer, 1000);
            state.timers.pacing = setInterval(updatePacingIndicators, 1000);
            state.timers.question = setInterval(updatePerQuestionTimer, 1000);
        }

        // --- Exam Logic ---
        function startNewExam() {
            const startQ = parseInt(startQuestionInput.value);
            const endQ = parseInt(endQuestionInput.value);

            if (startQ < 1 || endQ < startQ) {
                alert("Invalid question range. Please ensure Start Question is 1 or greater and not after the End Question.");
                return;
            }
            
            config.startQuestionNumber = startQ;
            config.totalQuestions = endQ - startQ + 1;
            config.totalTimeSeconds = parseInt(totalTimeInput.value) * 60;
            config.positiveMarking = parseFloat(positiveMarkingInput.value);
            config.negativeMarking = parseFloat(negativeMarkingInput.value);
            config.requiredPaceSeconds = config.totalTimeSeconds / config.totalQuestions;
            config.answerKey = answerKeyInput.value ? answerKeyInput.value.split(',').map(a => a.trim().toLowerCase()) : [];
            
            state = getInitialState();
            state.examData = Array.from({ length: config.totalQuestions }, (_, i) => ({
                id: config.startQuestionNumber + i,
                timeSpent: 0, markedForReview: false, status: CONSTANTS.STATUS_UNSEEN,
                outcome: null, selectedAnswer: null,
                correctAnswer: config.answerKey[i] || null,
                timeBankAtCompletion: null, 
            }));
            state.examStartTime = Date.now();
            
            startOrResumeExam();
            navigateToQuestion(0);
        }

        function startOrResumeExam() {
            requiredPaceEl.textContent = `${formatTime(config.requiredPaceSeconds)} / q`;
            markedCounterEl.textContent = state.markedCount;
            renderQuestionGrid();
            restartTimers();
            switchScreen('exam');
            if (state.currentQuestionIndex > 0) {
                navigateToQuestion(state.currentQuestionIndex, true);
            }
        }
        
        const updateMasterTimer = () => {
            const elapsed = (Date.now() - state.examStartTime) / 1000;
            const remaining = config.totalTimeSeconds - elapsed;
            masterTimerEl.classList.remove('text-danger', 'text-warning');
            if (remaining <= 0) {
                masterTimerEl.textContent = "00:00:00";
                masterTimerEl.classList.add('text-danger');
                endExam(true);
            } else {
                masterTimerEl.textContent = formatTime(remaining, true);
                if (remaining < 60) masterTimerEl.classList.add('text-danger');
                else if (remaining < 300) masterTimerEl.classList.add('text-warning');
            }
        };

        const updatePacingIndicators = () => {
            const questionsSeen = state.examData.filter(q => q.status !== CONSTANTS.STATUS_UNSEEN).length || 1;
            const timeElapsed = (Date.now() - state.examStartTime) / 1000;
            const currentPace = timeElapsed / questionsSeen;
            currentPaceEl.textContent = `${formatTime(currentPace)} / q`;
            const paceRatio = config.requiredPaceSeconds / currentPace;
            pacingBarInnerEl.className = 'progress-bar rounded-pill';
            if (paceRatio > 1.1) pacingBarInnerEl.classList.add('bg-success');
            else if (paceRatio >= 0.9) pacingBarInnerEl.classList.add('bg-warning');
            else pacingBarInnerEl.classList.add('bg-danger');
            const requiredTimeForProgress = config.requiredPaceSeconds * (state.currentQuestionIndex + 1);
            const timeBankSeconds = requiredTimeForProgress - timeElapsed;
            timeBankEl.textContent = (timeBankSeconds >= 0 ? '+' : '') + formatTime(timeBankSeconds);
            timeBankEl.classList.toggle('text-success', timeBankSeconds >= 0);
            timeBankEl.classList.toggle('text-danger', timeBankSeconds < 0);
        };

        const updatePerQuestionTimer = () => {
            if (!state.questionStartTime) {
                currentQTimerEl.textContent = formatTime(state.examData[state.currentQuestionIndex].timeSpent);
                return;
            }
            const elapsed = (Date.now() - state.questionStartTime) / 1000;
            currentQTimerEl.textContent = formatTime(elapsed);
        };

        function renderQuestionGrid() {
            questionGridEl.innerHTML = '';
            const statusClasses = {
                [CONSTANTS.STATUS_SEEN]: 'btn-outline-primary',
                [CONSTANTS.STATUS_UNSEEN]: 'btn-light',
            };
            state.examData.forEach((q, index) => {
                const btn = document.createElement('button');
                btn.className = `btn q-btn fw-bold ${statusClasses[q.status]}`;
                btn.textContent = q.id;
                if (index === state.currentQuestionIndex) {
                    btn.classList.add('btn-primary', 'current', 'shadow-lg');
                    btn.classList.remove('btn-outline-primary', 'btn-light');
                }
                if (q.markedForReview) btn.classList.add('border', 'border-3', 'border-warning');
                btn.onclick = () => navigateToQuestion(index);
                questionGridEl.appendChild(btn);
            });
        }

        function navigateToQuestion(index, isResuming = false) {
            if (index < 0 || index >= config.totalQuestions) return;
            const timeNow = Date.now();
            if (state.questionStartTime && !isResuming) {
                const timeSpentOnCurrent = (timeNow - state.questionStartTime) / 1000;
                state.examData[state.currentQuestionIndex].timeSpent += timeSpentOnCurrent;

                const timeElapsed = (timeNow - state.examStartTime) / 1000;
                const requiredTimeForProgress = config.requiredPaceSeconds * (state.currentQuestionIndex + 1);
                state.examData[state.currentQuestionIndex].timeBankAtCompletion = requiredTimeForProgress - timeElapsed;
            }
            clearInterval(state.timers.question);
            state.currentQuestionIndex = index;
            if (state.examData[index].status === CONSTANTS.STATUS_UNSEEN) {
                state.examData[index].status = CONSTANTS.STATUS_SEEN;
            }
            state.questionStartTime = timeNow;
            state.timers.question = setInterval(updatePerQuestionTimer, 1000);
            updatePerQuestionTimer();
            renderQuestionGrid();
            updateNavControls();
            updateAnswerButtonsUI();
            saveStateToLocalStorage();
        }

        function updateNavControls() {
            const currentQuestion = state.examData[state.currentQuestionIndex];
            currentQNumberEl.textContent = `Question ${currentQuestion.id}`;
            prevBtn.disabled = state.currentQuestionIndex === 0;
            nextBtn.disabled = state.currentQuestionIndex === config.totalQuestions - 1;
            markReviewBtn.textContent = currentQuestion.markedForReview ? 'Unmark' : 'Mark for Review';
            markReviewBtn.classList.toggle('btn-warning', currentQuestion.markedForReview);
            markReviewBtn.classList.toggle('btn-outline-secondary', !currentQuestion.markedForReview);
        }

        function selectAnswer(answer) {
            const currentQ = state.examData[state.currentQuestionIndex];
            currentQ.selectedAnswer = (currentQ.selectedAnswer === answer) ? null : answer;
            updateAnswerButtonsUI();
            saveStateToLocalStorage();
        }

        function updateAnswerButtonsUI() {
            const currentAnswer = state.examData[state.currentQuestionIndex].selectedAnswer;
            answerOptionButtons.forEach(btn => {
                const isSelected = btn.dataset.answer === currentAnswer;
                btn.classList.toggle('btn-primary', isSelected);
                btn.classList.toggle('btn-outline-secondary', !isSelected);
            });
        }

        const handleKeyPress = (e) => {
            if (state.isPaused) return;
            if (document.activeElement.tagName === 'INPUT' || e.ctrlKey || e.metaKey) return;
            switch (e.key.toLowerCase()) {
                case 'arrowright': if (!nextBtn.disabled) nextBtn.click(); break;
                case 'arrowleft': if (!prevBtn.disabled) prevBtn.click(); break;
                case 'm': markReviewBtn.click(); break;
                case 'a': case 'b': case 'c': case 'd': selectAnswer(e.key.toLowerCase()); break;
            }
        };

        function endExam(wasTimeout) {
            if (wasTimeout) {
                alert("Time's up! The exam has ended automatically.");
            }
            clearAllTimers();
            
            if (state.questionStartTime) {
                const timeNow = Date.now();
                const timeSpentOnCurrent = (timeNow - state.questionStartTime) / 1000;
                const currentQ = state.examData[state.currentQuestionIndex];
                currentQ.timeSpent += timeSpentOnCurrent;

                const timeElapsed = (timeNow - state.examStartTime) / 1000;
                const requiredTimeForProgress = config.requiredPaceSeconds * (state.currentQuestionIndex + 1);
                currentQ.timeBankAtCompletion = requiredTimeForProgress - timeElapsed;
            }

            clearStateFromLocalStorage();
            const allAttemptedHaveKey = state.examData
                .filter(q => q.status !== CONSTANTS.STATUS_UNSEEN && q.selectedAnswer !== null)
                .every(q => q.correctAnswer !== null);

            if (allAttemptedHaveKey) {
                generateAndShowAnalytics();
                switchScreen('analytics');
            } else {
                renderGradingScreen();
                switchScreen('grading');
            }
        }

        // --- Grading Logic ---
        function renderGradingScreen() {
            gradingListEl.innerHTML = '';
            state.examData.forEach((q, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex flex-column flex-sm-row justify-content-between align-items-sm-center gap-2';
                
                if (q.status === CONSTANTS.STATUS_UNSEEN || q.selectedAnswer === null) {
                    item.innerHTML = `<div class="d-flex align-items-center gap-3"><span>Question ${q.id}</span> <strong class="text-body-secondary">Not Tried</strong></div>`;
                } else {
                    item.innerHTML = `<div class="d-flex align-items-center flex-wrap gap-3">
                                          <span class="fw-bold">Q ${q.id}</span> 
                                          <span>Your Ans: <strong>${q.selectedAnswer.toUpperCase()}</strong></span> 
                                          <span class="text-body-secondary small">(Time: ${formatTime(q.timeSpent)})</span>
                                      </div>
                                      <div class="actions d-flex align-items-center gap-2 mt-2 mt-sm-0">
                                          <span class="me-2">Correct:</span>
                                          <div class="btn-group" role="group">
                                              ${['a','b','c','d'].map(ans => `<button class="btn btn-sm btn-outline-secondary" data-answer="${ans}" data-index="${index}">${ans.toUpperCase()}</button>`).join('')}
                                          </div>
                                      </div>`;
                }
                gradingListEl.appendChild(item);
            });
            checkGradingCompletion();
        }
        function handleGradingClick(e) {
            const button = e.target.closest('button[data-answer]');
            if (!button) return;
            const index = parseInt(button.dataset.index);
            const answer = button.dataset.answer;
            state.examData[index].correctAnswer = answer;
            const buttonGroup = button.parentElement;
            buttonGroup.querySelectorAll('.btn').forEach(b => b.classList.replace('btn-primary', 'btn-outline-secondary'));
            button.classList.replace('btn-outline-secondary', 'btn-primary');
            checkGradingCompletion();
        }
        function checkGradingCompletion() {
            const attemptedQuestions = state.examData.filter(q => q.status !== CONSTANTS.STATUS_UNSEEN && q.selectedAnswer !== null);
            const allAttemptedGraded = attemptedQuestions.every(q => q.correctAnswer !== null);
            generateAnalyticsBtn.disabled = !(allAttemptedGraded && attemptedQuestions.length > 0);
        }

        // --- Analytics Logic ---
        function destroyCharts() {
            Object.values(state.charts).forEach(chart => { if (chart instanceof Chart) chart.destroy(); });
            state.charts = { score: null, pace: null, timeBank: null };
        }
        
        function generateAndShowAnalytics() {
            destroyCharts();
            state.examData.forEach(q => {
                if (q.selectedAnswer !== null) {
                    q.outcome = q.selectedAnswer === q.correctAnswer ? CONSTANTS.OUTCOME_CORRECT : CONSTANTS.OUTCOME_INCORRECT;
                    q.paceDeviation = q.timeSpent - config.requiredPaceSeconds;
                } else { 
                    q.outcome = CONSTANTS.OUTCOME_UNATTEMPTED;
                    q.paceDeviation = null;
                }
            });

            const correctQs = state.examData.filter(q => q.outcome === CONSTANTS.OUTCOME_CORRECT);
            const incorrectQs = state.examData.filter(q => q.outcome === CONSTANTS.OUTCOME_INCORRECT);
            const attemptedQs = state.examData.filter(q => q.outcome !== CONSTANTS.OUTCOME_UNATTEMPTED);
            
            let totalScore = (correctQs.length * config.positiveMarking) - (incorrectQs.length * config.negativeMarking);
            const accuracy = attemptedQs.length > 0 ? (correctQs.length / attemptedQs.length) * 100 : 0;
            const paceCorrect = correctQs.length > 0 ? correctQs.reduce((s, q) => s + q.timeSpent, 0) / correctQs.length : 0;
            const paceIncorrect = incorrectQs.length > 0 ? incorrectQs.reduce((s, q) => s + q.timeSpent, 0) / incorrectQs.length : 0;
            const timeSinks = state.examData.filter(q => q.timeSpent > (config.requiredPaceSeconds * 2) && q.outcome === 'incorrect').length;

            document.getElementById('stat-score').textContent = totalScore.toFixed(2);
            document.getElementById('stat-accuracy').textContent = `${accuracy.toFixed(1)}%`;
            document.getElementById('stat-pace-correct').textContent = formatTime(paceCorrect);
            document.getElementById('stat-pace-incorrect').textContent = formatTime(paceIncorrect);
            document.getElementById('stat-answered').textContent = `${attemptedQs.length}/${config.totalQuestions}`;
            document.getElementById('stat-time-sinks').textContent = timeSinks;
            
            renderScoreDonutChart(correctQs, incorrectQs, attemptedQs);
            renderPacingScatterPlot();
            renderTimeBankChart();
            generateStrategicInsights(correctQs, incorrectQs, totalScore);
            renderDetailedTable();
        }

        function getBsColor(colorName) { return getComputedStyle(document.documentElement).getPropertyValue(`--bs-${colorName}`).trim(); }
        
        function renderScoreDonutChart(correctQs, incorrectQs, attemptedQs) {
            const ctx = document.getElementById('score-chart').getContext('2d');
            const unattemptedCount = config.totalQuestions - attemptedQs.length;
            state.charts.score = new Chart(ctx, {
                type: 'doughnut', data: {
                    labels: ['Correct', 'Incorrect', 'Not Tried'],
                    datasets: [{
                        data: [correctQs.length, incorrectQs.length, unattemptedCount],
                        backgroundColor: [getBsColor('success'), getBsColor('danger'), getBsColor('light-subtle')],
                        borderColor: getBsColor('body-bg'), borderWidth: 4, hoverOffset: 8
                    }]
                }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: getBsColor('body-color'), boxWidth: 12, padding: 20 } } } }
            });
        }

        function renderPacingScatterPlot() {
            const ctx = document.getElementById('pace-scatter-chart').getContext('2d');
            const correctData = state.examData.filter(q => q.outcome === 'correct').map(q => ({ x: q.id, y: q.timeSpent }));
            const incorrectData = state.examData.filter(q => q.outcome === 'incorrect').map(q => ({ x: q.id, y: q.timeSpent }));

            state.charts.pace = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Correct', data: correctData,
                        backgroundColor: getBsColor('success-bg-subtle'), borderColor: getBsColor('success'), borderWidth: 1.5, radius: 5, hoverRadius: 7,
                    }, {
                        label: 'Incorrect', data: incorrectData,
                        backgroundColor: getBsColor('danger-bg-subtle'), borderColor: getBsColor('danger'), borderWidth: 1.5, radius: 5, hoverRadius: 7,
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Time Spent (seconds)', color: getBsColor('secondary-color') } },
                        x: { 
                            type: 'linear', 
                            title: { display: true, text: 'Question Number', color: getBsColor('secondary-color') },
                            ticks: {
                                callback: function(value, index, ticks) {
                                    if (Math.floor(value) === value) { return value; }
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { color: getBsColor('body-color') } },
                        tooltip: { callbacks: { label: c => [`Q${c.raw.x}: ${c.dataset.label}`, `Time: ${formatTime(c.raw.y)}`] }},
                        annotation: {
                            annotations: {
                                requiredPaceLine: {
                                    type: 'line', yMin: config.requiredPaceSeconds, yMax: config.requiredPaceSeconds,
                                    borderColor: getBsColor('warning'), borderWidth: 2, borderDash: [6, 6],
                                    // REMOVED: Label that can overlap data points on small screens.
                                    label: { display: false }
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTimeBankChart() {
            const ctx = document.getElementById('time-bank-chart').getContext('2d');
            const answeredQuestions = state.examData.filter(q => q.timeBankAtCompletion !== null);

            if (answeredQuestions.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = "16px sans-serif";
                ctx.fillStyle = getBsColor('secondary-color');
                ctx.textAlign = "center";
                ctx.fillText("No attempted questions to analyze.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const chartData = answeredQuestions.map((q, index) => ({
                x: index + 1, y: q.timeBankAtCompletion, originalId: q.id
            }));
            
            chartData.unshift({x: 0, y: 0, originalId: 0});

            state.charts.timeBank = new Chart(ctx, {
                type: 'line', data: {
                    datasets: [{
                        label: 'Time Bank (seconds)', data: chartData,
                        borderColor: getBsColor('primary'), backgroundColor: getBsColor('primary-bg-subtle'),
                        fill: { target: 'origin', above: getBsColor('success-bg-subtle'), below: getBsColor('danger-bg-subtle') },
                        tension: 0.3, pointRadius: 4, pointHoverRadius: 7, borderWidth: 2.5,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'Sequence of Questions Answered' }, min: 0, ticks: { stepSize: 1 } },
                        y: { title: { display: true, text: 'Time Bank (s)' } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (context) => {
                                    const dataPoint = context[0].raw;
                                    if (dataPoint.x === 0) return 'Start of Exam';
                                    return `Answered #${dataPoint.x} (Question ${dataPoint.originalId})`;
                                },
                                label: (context) => `Time Bank: ${context.raw.y.toFixed(1)}s`
                            }
                        },
                        // MODIFIED: Removed the final time bank label which could overlap the chart.
                        // The final value is still visible by hovering the last point.
                        annotation: { 
                            annotations: { 
                                zeroLine: { type: 'line', yMin: 0, yMax: 0, borderColor: getBsColor('secondary'), borderWidth: 2, borderDash: [2, 2] }
                            } 
                        }
                    }
                }
            });
        }
        
        function generateStrategicInsights(correctQs, incorrectQs, originalScore) {
            const listEl = document.getElementById('strategic-insights-list');
            listEl.innerHTML = '';
            
            const pointsLostToIncorrect = incorrectQs.length * config.negativeMarking;
            const pointsNotGained = incorrectQs.length * config.positiveMarking;
            const totalSwing = pointsLostToIncorrect + pointsNotGained;

            listEl.innerHTML += `<li class="mb-3">
                <strong class="d-block text-danger">Cost of Mistakes</strong>
                Your ${incorrectQs.length} incorrect answers cost you a total of <strong>${totalSwing.toFixed(2)} points</strong> versus getting them correct.
            </li>`;

            if (incorrectQs.length > 0) {
                const scoreWithoutGuessing = (correctQs.length * config.positiveMarking);
                let text = `If you had left your ${incorrectQs.length} incorrect questions unanswered, your score would have been <strong>${scoreWithoutGuessing.toFixed(2)}</strong>.`;
                if (scoreWithoutGuessing > originalScore) {
                    text += ` This is <span class="text-success">${(scoreWithoutGuessing - originalScore).toFixed(2)} points higher</span>. Your guessing was not effective.`;
                } else {
                    text += ` This is <span class="text-danger">${(originalScore - scoreWithoutGuessing).toFixed(2)} points lower</span>. Aggressive guessing paid off.`;
                }
                listEl.innerHTML += `<li class="mb-3"><strong class="d-block text-primary">"No Guessing" Scenario</strong>${text}</li>`;
            }

            const timeSinks = state.examData.filter(q => q.outcome === 'incorrect' && q.timeSpent > (config.requiredPaceSeconds * 1.5));
            if (timeSinks.length > 0) {
                const timeWasted = timeSinks.reduce((sum, q) => sum + q.timeSpent, 0);
                listEl.innerHTML += `<li class="mb-3"><strong class="d-block text-warning">Time Sinks</strong>You spent over 1.5x the average pace on <strong>${timeSinks.length} questions</strong> that you got wrong, costing you <strong>${formatTime(timeWasted)}</strong>.</li>`;
            }
        }
        
        function renderDetailedTable() {
            detailedResultsTbody.innerHTML = '';
            const sortedData = [...state.examData].sort((a, b) => {
                let valA = a[state.sortState.key];
                let valB = b[state.sortState.key];
                
                if (state.sortState.key === 'paceDeviation') {
                    valA = valA ?? -Infinity;
                    valB = valB ?? -Infinity;
                }

                let comparison = 0;
                if (state.sortState.key === 'markedForReview') {
                    comparison = valA === valB ? 0 : valA ? -1 : 1;
                } else if (valA > valB) {
                    comparison = 1; 
                } else if (valA < valB) {
                    comparison = -1;
                }
                return state.sortState.direction === 'asc' ? comparison : comparison * -1;
            });
            
            const outcomeColors = { [CONSTANTS.OUTCOME_CORRECT]: 'success', [CONSTANTS.OUTCOME_INCORRECT]: 'danger', [CONSTANTS.OUTCOME_UNATTEMPTED]: 'secondary' };
            const outcomeText = { [CONSTANTS.OUTCOME_CORRECT]: 'Correct', [CONSTANTS.OUTCOME_INCORRECT]: 'Incorrect', [CONSTANTS.OUTCOME_UNATTEMPTED]: 'Not Tried' };
            const fragment = document.createDocumentFragment();

            sortedData.forEach(q => {
                const row = fragment.appendChild(document.createElement('tr'));
                if (q.markedForReview) row.classList.add('table-warning');
                const userAnswer = q.selectedAnswer ? q.selectedAnswer.toUpperCase() : '-';
                const correctAnswer = q.correctAnswer ? q.correctAnswer.toUpperCase() : '-';

                let deviationHtml = '-';
                if (q.paceDeviation !== null) {
                    const color = q.paceDeviation > 0 ? 'text-danger' : 'text-success';
                    const sign = q.paceDeviation > 0 ? '+' : '';
                    deviationHtml = `<span class="${color}">${sign}${Math.round(q.paceDeviation)}s</span>`;
                }

                row.innerHTML = `<td>${q.id}</td>
                                 <td>${userAnswer}</td>
                                 <td>${correctAnswer}</td>
                                 <td>${q.outcome === CONSTANTS.OUTCOME_UNATTEMPTED ? '-' : formatTime(q.timeSpent)}</td>
                                 <td>${deviationHtml}</td>
                                 <td><span class="badge rounded-pill text-bg-${outcomeColors[q.outcome]}">${outcomeText[q.outcome]}</span></td>
                                 <td>${q.markedForReview ? 'Yes' : 'No'}</td>`;
            });
            detailedResultsTbody.appendChild(fragment);

            document.querySelectorAll('#detailed-results-table .btn-sort').forEach(btn => {
                btn.textContent = btn.textContent.replace(' ▾', '').replace(' ▴', '');
                if (btn.dataset.sort === state.sortState.key) {
                    btn.textContent += state.sortState.direction === 'asc' ? ' ▾' : ' ▴';
                }
            });
        }

        function handleSortClick(e) {
            const key = e.currentTarget.dataset.sort;
            if (state.sortState.key === key) {
                state.sortState.direction = state.sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortState.key = key;
                state.sortState.direction = (key === 'timeSpent' || key === 'paceDeviation') ? 'desc' : 'asc';
            }
            renderDetailedTable();
        }

        function resetAndShowSetup() {
            destroyCharts();
            state = getInitialState();
            setupForm.reset();
            setupForm.classList.remove('d-none');
            resumePromptEl.classList.add('d-none');
            switchScreen('setup');
        }

        // --- Event Listeners ---
        setupForm.addEventListener('submit', (e) => { e.preventDefault(); startNewExam(); });
        answerOptionButtons.forEach(btn => btn.onclick = () => selectAnswer(btn.dataset.answer));
        prevBtn.onclick = () => navigateToQuestion(state.currentQuestionIndex - 1);
        nextBtn.onclick = () => navigateToQuestion(state.currentQuestionIndex + 1);
        markReviewBtn.onclick = () => {
            const currentQuestion = state.examData[state.currentQuestionIndex];
            currentQuestion.markedForReview = !currentQuestion.markedForReview;
            state.markedCount += currentQuestion.markedForReview ? 1 : -1;
            markedCounterEl.textContent = state.markedCount;
            updateNavControls();
            renderQuestionGrid();
            saveStateToLocalStorage();
        };
        finishBtn.onclick = () => {
            showConfirmation({
                title: 'Finish Exam?', message: 'Finish and grade the exam? This cannot be undone.',
                onConfirm: () => endExam(false), confirmText: 'Finish & Grade', confirmClass: 'btn-danger'
            });
        };
        gradingListEl.addEventListener('click', handleGradingClick);
        generateAnalyticsBtn.onclick = () => {
            generateAndShowAnalytics();
            switchScreen('analytics');
        };
        startNewBtn.onclick = () => {
            showConfirmation({
                title: 'Start New Exam?', message: 'This will erase the current report. Start a new exam?',
                onConfirm: resetAndShowSetup, confirmText: 'Start New', confirmClass: 'btn-primary'
            });
        };
        document.querySelectorAll('#detailed-results-table .btn-sort').forEach(th => th.addEventListener('click', handleSortClick));
        pauseBtn.addEventListener('click', pauseExam);
        resumePausedBtn.addEventListener('click', resumeFromPause);

        // --- Initializer ---
        function init() {
            const savedState = loadStateFromLocalStorage();
            if (savedState) {
                setupForm.classList.add('d-none');
                resumePromptEl.classList.remove('d-none');
                resumeBtn.onclick = () => handleResume(savedState);
                discardBtn.onclick = () => {
                    clearStateFromLocalStorage();
                    resumePromptEl.classList.add('d-none');
                    setupForm.classList.remove('d-none');
                };
            }
            switchScreen('setup');
        }

        init();
    })();
    </script>

</body>
</html>